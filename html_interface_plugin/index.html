<!DOCTYPE html>
<html>
<head>
    <title>PyMOL HTML Interface</title>
    <!-- Include the QWebChannel JavaScript file -->
    <script src="qwebchannel.js"></script>
    <script src="sviewer-browser.bundle.js"></script>
    <script src="reglyco-selector.js"></script>
    <script src="config_response.json"></script>
    <style>
        body { font-family: sans-serif; padding: 10px; }
        .output { border: 1px solid #ccc; padding: 8px; min-height: 50px; background-color: #f9f9f9; margin-top: 10px; white-space: pre-wrap; }
        button { margin-top: 5px; margin-right: 5px; padding: 5px 10px;}
        input[type="text"] { width: 300px; padding: 5px; margin-right: 5px; }
    </style>
</head>
<body>
<style>
ccg-sugarselect, my-select, reglyco-selector {
    resize: both;
    overflow: auto;
    --max-select-display: 19;
    --selection-color: rgba(90,200,200,1);
    --button-default-background-color: #eee;
    --palette-closer-style: var(--palette-closer-light);
}
</style>
<script type="text/javascript">

    const REGLYCO_CONFIG = { 'configuration': {} };

    async function upload_pdb(pdb) {

        document.getElementById('content').innerText = 'Making request';
        const blob = new Blob([pdb], {
          type: 'chemical/x-pdb',
        });
        const formdata = new FormData();
        formdata.append('protFile', blob,'pdbfile.pdb');
        const response = await fetch('https://glycoshape.org/api/reglyco/init', {
          method: 'POST',
          body: formdata
        });

        let response_json = await response.json();
        // console.log(JSON.stringify(response_json));
        // let response_json = response;
        document.getElementById('selector').configuration = response_json;

        /*

curl -X POST https://glycoshape.io/api/reglyco/job -H "Content-Type: application/json" -d '{"jobId": "job2", "jobType": "optimization", "filename": "P01857.pdb", "selectedGlycans": {"50_A": "G00031MO"}}'
        Or provide protFileBase64 
        */

    }

</script>
    <h1>Glyco.me x ReGlyco</h1>

    <reglyco-selector id="selector"></reglyco-selector>

    <div id="content"></div>

    <!-- Section to send commands to PyMOL -->
    <h2>Send Command to PyMOL</h2>
    <input type="text" id="pymolCommand" value="color red, chain A">
    <button id="sendCmdButton" onclick="upload_pdb()">Send Command</button>
    <div id="sendCommandStatus"></div>

    <!-- Section to receive data from PyMOL -->
    <h2>Data from PyMOL</h2>
    <button id="getDataButton">Request PyMOL Data</button>
    <div id="pymolData" class="output">Waiting for data...</div>

    <script>
        var pyMolBridge = null; // Global variable to hold the Python bridge object

        window.onload = function() {
            document.getElementById('getDataButton').addEventListener('click',upload_pdb);
            if (typeof qt === 'undefined' || typeof qt.webChannelTransport === 'undefined') {
                console.error("qt or qt.webChannelTransport is not defined. QWebChannel cannot be initialized.");
                alert("Error: Cannot connect to PyMOL. Is the Qt WebChannel environment set up correctly?");
                document.getElementById('pymolData').innerText = "Error: QWebChannel not available.";
                return;
            }

            // Initialize the QWebChannel
            new QWebChannel(qt.webChannelTransport, function (channel) {
                // Get the bridge object published by Python (named 'pyMolBridge')
                pyMolBridge = channel.objects.pyMolBridge;

                if (!pyMolBridge) {
                     console.error("Failed to get pyMolBridge object from channel.");
                     document.getElementById('pymolData').innerText = "Error: Connection object not found.";
                     return;
                }

                console.log("PyMOL Bridge connected:", pyMolBridge);
                document.getElementById('pymolData').innerText = "Connected to PyMOL.";

                // --- Setup Event Listeners ---

                // Button to send command *to* PyMOL
                document.getElementById('sendCmdButton').onclick = function() {
                    if (!pyMolBridge) return;
                    var cmd = document.getElementById('pymolCommand').value;
                    console.log("Sending command to PyMOL:", cmd);
                    document.getElementById('sendCommandStatus').innerText = `Sending: ${cmd}...`;
                    // Call the Python slot 'executePymolCommand'
                    pyMolBridge.executePymolCommand(cmd, function(result) {
                        // This callback receives the return value from Python
                        console.log("PyMOL execution result:", result);
                        document.getElementById('sendCommandStatus').innerText = `Result: ${result}`;
                    });
                };

                // Button to request data *from* PyMOL
                document.getElementById('getDataButton').onclick = function() {
                    if (!pyMolBridge) return;
                    console.log("Requesting data from PyMOL...");
                     document.getElementById('pymolData').innerText = "Requesting...";
                    // Call the Python slot 'getDataFromPyMol'
                    pyMolBridge.getDataFromPyMol("molecule_names", function(data) {
                         // This callback receives the data from Python
                         console.log("Received data from PyMOL:", data);
                         document.getElementById('pymolData').innerText = `PyMOL says: ${JSON.stringify(data, null, 2)}`;
                    });
                };

            });
        };

        // --- Function callable *from* PyMOL ---
        function updateFromPyMol(message) {
            console.log("Message received directly from PyMOL:", message);
            const dataDiv = document.getElementById('pymolData');
            dataDiv.innerText = `Direct message from PyMOL: ${JSON.stringify(message, null, 2)}`;
            // You could add more complex logic here based on the message type/content
            if (message.type == "pdb_file") {
                upload_pdb(message.content);
            }
        }

    </script>
</body>
</html>